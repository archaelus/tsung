#!/bin/sh

HOST=`hostname -s`

INSTALL_DIR=%INSTALL_DIR%
ERL=%ERL%
MAIN_DIR=$HOME/.idx-tsunami
LOG_DIR=$MAIN_DIR/log
LOG_OPT="log_file \"$LOG_DIR/idx-tsunami.log\""
VERSION=%VERSION%

LISTEN_PORT=8090
NAME=idx-tsunami
CONTROLLER=tsunami_controller
RECORDER=tsunami_recorder

TSUNAMIPATH=%INSTALL_DIR%/lib/tsunami-$VERSION/ebin
CONTROLLERPATH=%INSTALL_DIR%/lib/tsunami_controller-$VERSION/ebin
RECORDERPATH=%INSTALL_DIR%/lib/tsunami_recorder-$VERSION/ebin

CONF_OPT_FILE="$HOME/.idx-tsunami/idx-tsunami.xml"
BOOT_OPT="-boot %INSTALL_DIR%/lib/tsunami_controller-$VERSION/priv/tsunami_controller -boot_var TSUNAMIPATH  %INSTALL_DIR% "
REC_BOOT_OPT="-boot %INSTALL_DIR%/lib/tsunami_recorder-$VERSION/priv/tsunami_recorder -boot_var TSUNAMIPATH  %INSTALL_DIR% "
REC_DEBUG_LEVEL=5
ERL_RSH=" -rsh ssh "
ERL_OPTS=" +A 1 %ERL_OPTS% "
COOKIE='tsunami'

stop() {
    $ERL $ERL_OPTS $ERL_RSH -noshell  -sname killer -setcookie $COOKIE -pa $TSUNAMIPATH -pa $CONTROLLERPATH -s tsunami_controller stop_all $HOST -s init stop
}

stop_recorder() {
    $ERL $ERL_OPTS $ERL_RSH -noshell  -sname killer -setcookie $COOKIE -pa $TSUNAMIPATH -pa $RECORDERPATH -s tsunami_recorder stop_all $HOST -s init stop
}

start() {
    echo "Starting IDX-Tsunami"	
    $ERL $ERL_OPTS $ERL_RSH -detached -sname $CONTROLLER -setcookie $COOKIE  $BOOT_OPT \
    -pa $TSUNAMIPATH -pa $CONTROLLERPATH \
    -tsunami_controller config_file \"$CONF_OPT_FILE\" -tsunami_controller $LOG_OPT
}

recorder() {
    echo "Starting IDX-Tsunami recorder on port $LISTEN_PORT"
    $ERL $ERL_OPTS $ERL_RSH -detached -sname $RECORDER -setcookie $COOKIE  $REC_BOOT_OPT \
    -pa $TSUNAMIPATH -pa $RECORDERPATH -pa $CONTROLLERPATH \
    -tsunami_recorder debug_level $REC_DEBUG_LEVEL \
    -tsunami_recorder $LOG_OPT \
    -tsunami_recorder proxy_log_file \"$MAIN_DIR/idx-tsunami_recorder.xml\" \
    -tsunami_recorder proxy_listen_port $LISTEN_PORT
}

debug() {
    $ERL $ERL_OPTS $ERL_RSH -sname $CONTROLLER -setcookie $COOKIE  $BOOT_OPT \
     -pa $TSUNAMIPATH -pa $CONTROLLERPATH \
     -tsunami_controller config_file \"$CONF_OPT_FILE\" \
     -tsunami_controller $LOG_OPT
}

checkconfig() {
	if [ ! -e $CONF_OPT_FILE ]
	then
		echo "Config file $CONF_OPT_FILE doesn't exist, aborting !"
		exit 1
	fi
}

maindir() {
	if [ ! -d $MAIN_DIR ]
	then
		echo "Creating local tsunami directory $MAIN_DIR"
		mkdir $MAIN_DIR
	fi
}

logdir() {
        if [ ! -d $LOG_DIR ]
        then
                echo "Creating idx-tsunami log directory $LOG_DIR"
                mkdir $LOG_DIR
        fi
}

status() {
    $ERL -noshell -sname tsunami_status -setcookie $COOKIE -pa $TSUNAMIPATH -pa $CONTROLLERPATH -s tsunami_controller status $HOST -s init stop
}

usage() {
    prog=`basename $1`
    echo "$prog start|stop|restart|debug|status|recorder|stop_recorder"
}

while getopts ":f:l:d:r:" Option
do
    case $Option in
        f) CONF_OPT_FILE=$OPTARG;;
        l) LOG_OPT="log_file \"$OPTARG\" ";;
        d) REC_DEBUG_LEVEL=$OPTARG;;
        r) ERL_RSH=" -rsh $OPTARG ";;
        *) usage ;;
    esac
done	
shift $(($OPTIND - 1))

case $1 in
    start)
		checkconfig
        maindir
        logdir
        start
        ;;

    recorder)
        maindir
        logdir
        recorder
        ;;

    debug)
		checkconfig
        maindir
        logdir
        debug
        ;;

    stop)
        stop
        ;;
    stop_recorder)
        stop_recorder
        ;;

    status)
        status
        ;;

    restart)
        stop
        start
        ;;

    *)
        usage $0
        ;;
esac
